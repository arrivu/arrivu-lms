// Generated by CoffeeScript 1.3.3
(function() {
  var __hasProp = {}.hasOwnProperty,
    __extends = function(child, parent) { for (var key in parent) { if (__hasProp.call(parent, key)) child[key] = parent[key]; } function ctor() { this.constructor = child; } ctor.prototype = parent.prototype; child.prototype = new ctor(); child.__super__ = parent.prototype; return child; },
    __slice = [].slice;

  define(['use!vendor/backbone', 'underscore', 'compiled/util/mixin', 'compiled/backbone-ext/DefaultUrlMixin'], function(Backbone, _, mixin, DefaultUrlMixin) {
    return Backbone.Collection = (function(_super) {

      __extends(Collection, _super);

      function Collection() {
        return Collection.__super__.constructor.apply(this, arguments);
      }

      Collection.mixin = function() {
        var mixins;
        mixins = 1 <= arguments.length ? __slice.call(arguments, 0) : [];
        return mixin.apply(null, [this].concat(__slice.call(mixins)));
      };

      Collection.mixin(DefaultUrlMixin);

      Collection.prototype.defaults = {
        params: void 0,
        resourceName: void 0,
        contextAssetString: void 0
      };

      Collection.optionProperty = function(property) {
        return this.__optionProperties__ = (this.__optionProperties__ || []).concat([property]);
      };

      Collection.prototype.setOptionProperties = function() {
        var property, _i, _len, _ref, _results;
        _ref = this.constructor.__optionProperties__;
        _results = [];
        for (_i = 0, _len = _ref.length; _i < _len; _i++) {
          property = _ref[_i];
          if (this.options[property] !== void 0) {
            _results.push(this[property] = this.options[property]);
          } else {
            _results.push(void 0);
          }
        }
        return _results;
      };

      Collection.prototype.initialize = function(models, options) {
        this.options = _.extend({}, this.defaults, options);
        this.setOptionProperties();
        return Collection.__super__.initialize.apply(this, arguments);
      };

      Collection.prototype.setParam = function(name, value) {
        var _base, _ref;
        if ((_ref = (_base = this.options).params) == null) {
          _base.params = {};
        }
        this.options.params[name] = value;
        return this.trigger('setParam', name, value);
      };

      Collection.prototype.setParams = function(params) {
        var name, value;
        for (name in params) {
          value = params[name];
          this.setParam(name, value);
        }
        return this.trigger('setParams', params);
      };

      Collection.prototype.deleteParam = function(name) {
        var _ref;
        if ((_ref = this.options.params) != null) {
          delete _ref[name];
        }
        return this.trigger('deleteParam', name);
      };

      Collection.prototype.fetch = function(options) {
        var _this = this;
        if (options == null) {
          options = {};
        }
        if (!(options.data != null) && (this.options.params != null)) {
          options.data = this.options.params;
        }
        return Collection.__super__.fetch.call(this, options).fail(function(xhr) {
          return _this.trigger('fetch:fail', xhr);
        });
      };

      Collection.prototype.url = function() {
        return this._defaultUrl();
      };

      Collection.optionProperty('contextAssetString');

      Collection.optionProperty('resourceName');

      Collection.prototype.parse = function(response, options) {
        var primaryCollection;
        if ((response != null ? response.meta : void 0) == null) {
          return Collection.__super__.parse.apply(this, arguments);
        }
        primaryCollection = response[response.meta.primaryCollection];
        _.each(this.sideLoad || {}, function(meta, relation) {
          var collection, foreignKey, index;
          if (_.isBoolean(meta) && meta) {
            meta = {};
          }
          if (_.isString(meta)) {
            meta = {
              collection: meta
            };
          }
          if (!_.isObject(meta)) {
            return;
          }
          foreignKey = meta.foreignKey, collection = meta.collection;
          if (foreignKey == null) {
            foreignKey = "" + relation + "_id";
          }
          if (collection == null) {
            collection = "" + relation + "s";
          }
          collection = response[collection] || [];
          index = {};
          _.each(collection, function(item) {
            return index[item.id] = item;
          });
          return _.each(primaryCollection, function(item) {
            var id, related;
            id = item[foreignKey];
            related = index[id];
            if ((id != null) && (related != null)) {
              item[relation] = related;
              return delete item[foreignKey];
            }
          });
        });
        return Collection.__super__.parse.call(this, primaryCollection, options);
      };

      return Collection;

    })(Backbone.Collection);
  });

}).call(this);
