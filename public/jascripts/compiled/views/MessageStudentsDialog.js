// Generated by CoffeeScript 1.3.3
(function() {
  var __bind = function(fn, me){ return function(){ return fn.apply(me, arguments); }; },
    __hasProp = {}.hasOwnProperty,
    __extends = function(child, parent) { for (var key in parent) { if (__hasProp.call(parent, key)) child[key] = parent[key]; } function ctor() { this.constructor = child; } ctor.prototype = parent.prototype; child.prototype = new ctor(); child.__super__ = parent.prototype; return child; };

  define(['i18n!quizzes', 'compiled/views/ValidatedFormView', 'jst/messageStudentsDialog', 'compiled/models/Conversation', 'jst/_messageStudentsWhoRecipientList', 'underscore', 'compiled/jquery/serializeForm'], function(I18n, ValidatedFormView, messageStudentsDialog, Conversation, recipientList, _) {
    var MessageStudentsDialog;
    return MessageStudentsDialog = (function(_super) {

      __extends(MessageStudentsDialog, _super);

      function MessageStudentsDialog() {
        this.updateListOfRecipients = __bind(this.updateListOfRecipients, this);

        this.getFormData = __bind(this.getFormData, this);

        this._findRecipientGroupByName = __bind(this._findRecipientGroupByName, this);

        this.validateBeforeSave = __bind(this.validateBeforeSave, this);

        this.toJSON = __bind(this.toJSON, this);
        return MessageStudentsDialog.__super__.constructor.apply(this, arguments);
      }

      MessageStudentsDialog.optionProperty('recipientGroups');

      MessageStudentsDialog.optionProperty('context');

      MessageStudentsDialog.prototype.els = {
        '[name=recipientGroupName]': '$recipientGroupName',
        '#message-recipients': '$messageRecipients',
        '[name=body]': '$messageBody'
      };

      MessageStudentsDialog.prototype.template = messageStudentsDialog;

      MessageStudentsDialog.prototype.className = 'validated-form-view form-dialog';

      MessageStudentsDialog.prototype.initialize = function(opts) {
        MessageStudentsDialog.__super__.initialize.apply(this, arguments);
        this.title = this.context ? I18n.t('message_students_for_context', 'Message students for %{context}', {
          context: this.context
        }) : I18n.t('message_students', 'Message students');
        this.recipients = this.recipientGroups[0].recipients;
        return this.model || (this.model = new Conversation);
      };

      MessageStudentsDialog.prototype.events = _.extend({}, ValidatedFormView.prototype.events, {
        'change [name=recipientGroupName]': 'updateListOfRecipients',
        'click .dialog_closer': 'close'
      });

      MessageStudentsDialog.prototype.toJSON = function() {
        var json, key, _i, _len, _ref;
        json = {};
        _ref = ['title', 'recipients', 'recipientGroups'];
        for (_i = 0, _len = _ref.length; _i < _len; _i++) {
          key = _ref[_i];
          json[key] = this[key];
        }
        return json;
      };

      MessageStudentsDialog.prototype.validateBeforeSave = function(data, errors) {
        var errs;
        errs = this.model.validate(data);
        if (errs) {
          if (errs.body) {
            errors.body = errs.body;
          }
          if (errs.recipients) {
            errors.recipientGroupName = errs.recipients;
          }
        }
        return errors;
      };

      MessageStudentsDialog.prototype._findRecipientGroupByName = function(name) {
        return _.detect(this.recipientGroups, function(grp) {
          return grp.name === name;
        });
      };

      MessageStudentsDialog.prototype.getFormData = function() {
        var body, recipientGroupName, recipients, _ref;
        _ref = this.$el.toJSON(), recipientGroupName = _ref.recipientGroupName, body = _ref.body;
        recipients = this._findRecipientGroupByName(recipientGroupName).recipients;
        return {
          body: body,
          recipients: _.pluck(recipients, 'id')
        };
      };

      MessageStudentsDialog.prototype.updateListOfRecipients = function() {
        var groupName, recipients;
        groupName = this.$recipientGroupName.val();
        recipients = this._findRecipientGroupByName(groupName).recipients;
        return this.$messageRecipients.html(recipientList({
          recipients: recipients
        }));
      };

      MessageStudentsDialog.prototype.onSaveSuccess = function() {
        this.close();
        return $.flashMessage(I18n.t('notices.message_sent', "Message Sent!"));
      };

      MessageStudentsDialog.prototype.open = function() {
        this.render();
        return this.$el.dialog({
          autoOpen: false,
          height: 500,
          width: 500,
          title: this.title
        }).dialog('open');
      };

      MessageStudentsDialog.prototype.close = function() {
        this.$el.dialog('close');
        return this.remove();
      };

      return MessageStudentsDialog;

    })(ValidatedFormView);
  });

}).call(this);
