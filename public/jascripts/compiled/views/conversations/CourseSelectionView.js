// Generated by CoffeeScript 1.3.3
(function() {
  var __bind = function(fn, me){ return function(){ return fn.apply(me, arguments); }; },
    __hasProp = {}.hasOwnProperty,
    __extends = function(child, parent) { for (var key in parent) { if (__hasProp.call(parent, key)) child[key] = parent[key]; } function ctor() { this.constructor = child; } ctor.prototype = parent.prototype; child.prototype = new ctor(); child.__super__ = parent.prototype; return child; };

  define(['i18n!conversations', 'underscore', 'Backbone', 'jst/conversations/courseOptions', 'use!vendor/bootstrap/bootstrap-dropdown', 'use!vendor/bootstrap-select/bootstrap-select'], function(I18n, _, _arg, template) {
    var Collection, CourseSelectionView, View;
    View = _arg.View, Collection = _arg.Collection;
    return CourseSelectionView = (function(_super) {

      __extends(CourseSelectionView, _super);

      function CourseSelectionView() {
        this.truncate_course = __bind(this.truncate_course, this);

        this.loadAll = __bind(this.loadAll, this);

        this.render = __bind(this.render, this);
        return CourseSelectionView.__super__.constructor.apply(this, arguments);
      }

      CourseSelectionView.prototype.events = {
        'change': 'onChange'
      };

      CourseSelectionView.prototype.initialize = function() {
        CourseSelectionView.__super__.initialize.call(this);
        if (!this.options.defaultOption) {
          this.options.defaultOption = I18n.t('all_courses', 'All Courses');
        }
        this.$el.addClass('show-tick');
        this.$el.selectpicker({
          useSubmenus: true
        }).next().on('mouseover', this.loadAll).find('.dropdown-toggle').on('focus', this.loadAll);
        this.options.courses.favorites.on('reset', this.render);
        this.options.courses.all.on('reset', this.render);
        return this.render();
      };

      CourseSelectionView.prototype.render = function() {
        var concluded, data, more,
          _this = this;
        CourseSelectionView.__super__.render.call(this);
        more = [];
        concluded = [];
        this.options.courses.all.each(function(course) {
          var collection;
          if (_this.options.courses.favorites.get(course.id)) {
            return;
          }
          collection = course.get('workflow_state') === 'completed' ? concluded : more;
          return collection.push(course.toJSON());
        });
        data = {
          defaultOption: this.options.defaultOption,
          favorites: this.options.courses.favorites.toJSON(),
          more: more,
          concluded: concluded
        };
        this.truncate_course_name_data(data);
        this.$el.html(template(data));
        this.$el.selectpicker('refresh');
        if (!this.renderValue()) {
          return this.loadAll();
        }
      };

      CourseSelectionView.prototype.loadAll = function() {
        var all;
        all = this.options.courses.all;
        if (all._loading) {
          return;
        }
        all.fetch();
        return all._loading = true;
      };

      CourseSelectionView.prototype._value = '';

      CourseSelectionView.prototype.setValue = function(value) {
        this._value = value || '';
        this.renderValue();
        return this.triggerEvent();
      };

      CourseSelectionView.prototype.renderValue = function() {
        this.$el.selectpicker('val', this._value);
        return this.$el.val() === this._value;
      };

      CourseSelectionView.prototype.onChange = function() {
        this._value = this.$el.val();
        return this.triggerEvent();
      };

      CourseSelectionView.prototype.triggerEvent = function() {
        return this.trigger('course', {
          name: this.$el.find(':selected').text().trim(),
          id: this._value
        });
      };

      CourseSelectionView.prototype.focus = function() {
        return this.$el.next().find('.dropdown-toggle').focus();
      };

      CourseSelectionView.prototype.truncate_course_name_data = function(course_data) {
        var _this = this;
        return _.each(['favorites', 'more', 'concluded'], function(key) {
          return _this.truncate_course_names(course_data[key]);
        });
      };

      CourseSelectionView.prototype.truncate_course_names = function(courses) {
        return _.each(courses, this.truncate_course);
      };

      CourseSelectionView.prototype.truncate_course = function(course) {
        var name, truncated;
        name = course['name'];
        truncated = this.middle_truncate(name);
        if (name !== truncated) {
          return course['truncated_name'] = truncated;
        }
      };

      CourseSelectionView.prototype.middle_truncate = function(name) {
        if (name.length > 25) {
          return name.slice(0, 10) + "&hellip;" + name.slice(-10);
        } else {
          return name;
        }
      };

      return CourseSelectionView;

    })(View);
  });

}).call(this);
